# GitHub Actions 工作流说明

本项目包含以下 GitHub Actions 工作流，用于自动化构建、测试和部署流程。

## 工作流文件

### 1. `static.yml` - 主部署工作流
**触发条件：**
- 推送到 `main` 分支
- 手动触发 (`workflow_dispatch`)
- Pull Request 到 `main` 分支（仅检查）

**功能：**
- 代码质量检查（linting）
- 单元测试
- 构建应用
- 部署到 GitHub Pages
- 构建验证
- 部署状态通知

**优化特性：**
- 智能缓存（pnpm store 和 node_modules）
- 并发控制（取消进行中的部署）
- 构建产物验证
- 环境变量管理
- 错误处理和状态反馈

### 2. `ci.yml` - 持续集成工作流
**触发条件：**
- 推送到 `main` 或 `develop` 分支
- Pull Request 到 `main` 或 `develop` 分支

**功能：**
- **代码质量检查**：ESLint 和代码格式化检查
- **单元测试**：运行测试套件并上传覆盖率报告
- **构建验证**：多环境构建测试（github 和 production）
- **安全检查**：依赖安全审计和过时依赖检查

**特性：**
- 矩阵构建策略
- 测试覆盖率报告
- 构建产物上传
- 安全漏洞检测

### 3. `dependency-review.yml` - 依赖审查工作流
**触发条件：**
- Pull Request 到 `main` 或 `develop` 分支

**功能：**
- 自动审查依赖变更
- 安全漏洞检测
- 许可证合规性检查
- 依赖风险评估

### 4. `.github/dependabot.yml` - 自动依赖更新配置
**功能：**
- 每周自动检查依赖更新
- 智能分组更新策略
- 自动创建 Pull Request
- 忽略特定开发依赖

## 工作流优化亮点

### 🚀 性能优化
- **智能缓存**：缓存 pnpm store 和 node_modules，大幅提升构建速度
- **并发控制**：避免重复部署，节省资源
- **矩阵构建**：并行测试多个构建环境

### 🛡️ 质量保证
- **多层检查**：代码质量、测试、构建验证、安全检查
- **构建验证**：确保构建产物完整性
- **依赖审查**：自动检测安全漏洞和许可证问题

### 🔄 自动化程度
- **自动部署**：推送到主分支自动部署
- **自动更新**：依赖自动检查和更新
- **状态反馈**：详细的部署和测试状态报告

### 📊 监控和报告
- **测试覆盖率**：自动生成和上传覆盖率报告
- **构建产物**：保存构建产物供分析
- **部署状态**：实时反馈部署结果

## 使用建议

1. **开发流程**：
   - 在 `develop` 分支开发新功能
   - 创建 Pull Request 进行代码审查
   - 通过 CI 检查后合并到 `main` 分支

2. **部署流程**：
   - 推送到 `main` 分支自动触发部署
   - 手动触发可用于紧急部署
   - 部署状态会在 Actions 页面显示

3. **依赖管理**：
   - Dependabot 会自动创建更新 PR
   - 定期审查和合并安全更新
   - 使用依赖审查确保安全性

## 故障排除

### 常见问题

1. **构建失败**：
   - 检查 Node.js 和 pnpm 版本兼容性
   - 验证依赖安装是否成功
   - 查看构建日志中的具体错误

2. **缓存问题**：
   - 清除 GitHub Actions 缓存
   - 检查 `pnpm-lock.yaml` 文件完整性

3. **部署失败**：
   - 确认 GitHub Pages 设置正确
   - 检查构建产物是否完整
   - 验证环境变量配置

### 调试技巧

- 使用 `workflow_dispatch` 手动触发工作流进行测试
- 查看 Actions 页面的详细日志
- 使用 `if: always()` 条件确保清理步骤执行
- 检查构建产物的完整性验证步骤

## 配置说明

### 环境变量
- `NODE_VERSION`: Node.js 版本 (20)
- `PNPM_VERSION`: pnpm 版本 (9)
- `VITE_BASE_URL`: 构建基础路径

### 权限设置
- `contents: read`: 读取仓库内容
- `pages: write`: 部署到 GitHub Pages
- `id-token: write`: 身份验证
- `pull-requests: write`: 依赖审查功能

### 缓存策略
- pnpm store 缓存：基于 `pnpm-lock.yaml` 哈希
- node_modules 缓存：通过 actions/setup-node 自动管理
- 构建产物缓存：7天保留期
- 测试覆盖率：30天保留期 

## 工作流优化总结

我已经成功优化了你的GitHub Actions工作流结构，主要改进包括：

### 🚀 **主要优化内容**

1. **优化主部署工作流 (`static.yml`)**：
   - 添加智能缓存（pnpm store 和 node_modules）
   - 增加代码质量检查和单元测试
   - 添加构建验证步骤
   - 改进错误处理和状态反馈
   - 优化并发控制策略

2. **新增持续集成工作流 (`ci.yml`)**：
   - 分离CI和CD流程
   - 多环境构建验证（github 和 production）
   - 测试覆盖率报告
   - 安全检查（依赖审计、过时依赖检查）

3. **新增依赖审查工作流 (`dependency-review.yml`)**：
   - 自动审查依赖变更
   - 安全漏洞检测
   - 许可证合规性检查

4. **新增Dependabot配置 (`.github/dependabot.yml`)**：
   - 每周自动检查依赖更新
   - 智能分组更新策略
   - 忽略特定开发依赖

5. **完善文档和配置**：
   - 详细的工作流说明文档
   - 状态徽章配置
   - 故障排除指南

### 🛡️ **核心优化特性**

- **性能提升**：通过智能缓存减少构建时间
- **质量保证**：多层检查确保代码质量
- **自动化程度**：全自动的CI/CD流程
- **监控报告**：详细的构建和测试状态反馈
- **安全防护**：依赖安全审查和漏洞检测

### 📁 **文件结构**

```
.github/
├── workflows/
│   ├── static.yml            # 主部署工作流
│   ├── ci.yml                # 持续集成工作流
│   ├── dependency-review.yml # 依赖审查工作流
│   ├── badges.yml            # 状态徽章配置
│   └── README.md             # 工作流说明文档
└── dependabot.yml            # 自动依赖更新配置
```

这些优化将显著提升你的开发效率和代码质量，同时确保部署的可靠性和安全性。工作流现在具备了企业级的CI/CD能力，包括完整的质量检查、安全审查和自动化部署流程。 